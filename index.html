<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WeChat</title>
<meta name="description" content="Note Taking for Traumagenic Systems (DID & OSDD)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content="TwiNote Note Taking, DID OSDD, Traumagenic System">
<style>
:root {
  --bg:#1e1e1e;
  --panel:#2b2b2b;
  --text:#ffffff;
}

body.light {
  --bg:#f4f4f4;
  --panel:#ffffff;
  --text:#000000;
}

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial;
  display:flex;
  height:100vh;
  font-size: 20pt;
}
button {
  font-size: 18pt;
}
select {
  font-size: 18pt;
}

input{
  font-size: 20pt;
}

#sidebar {
  width:250px;
  background:var(--panel);
  padding:10px;
  overflow-y:auto;
}

.textpopcolor {
  color: #ffffff;
}

.box {
  width: 40%;
  margin: 0 auto;
  background: rgba(255,255,255,0.2);
  padding: 35px;
  border: 2px solid #fff;
  border-radius: 20px/50px;
  background-clip: padding-box;
  text-align: center;
}

.button {
  font-size: 1em;
  background-color: black;
  padding: 10px;
  color: white;
  border: 2px solid white;
  border-radius: 20px/50px;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s ease-out;
  font-size: 20pt;
}
.button:hover {
  background: black;
}

.overlay {
  position: fixed;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.7);
  transition: opacity 500ms;
  visibility: hidden;
  opacity: 0;
}
.overlay:target {
  visibility: visible;
  opacity: 1;
}

.popup {
  margin: 70px auto;
  padding: 20px;
  background: Black;
  border-radius: 5px;
  width: 30%;
  position: relative;
  transition: all 5s ease-in-out;
}

.popup h2 {
  margin-top: 0;
  color: rgb(255, 255, 255);
  font-family: Tahoma, Arial, sans-serif;
}
.popup .close {
  position: absolute;
  top: 20px;
  right: 30px;
  transition: all 200ms;
  font-size: 30px;
  font-weight: bold;
  text-decoration: none;
  color: rgb(255, 255, 255);
}
.popup .close:hover {
  color: #d80606;
}
.popup .content {
  max-height: 30%;
  overflow: auto;
}

@media screen and (max-width: 700px){
  .box{
    width: 70%;
  }
  .popup{
    width: 70%;
  }
}

#main {
  flex:1;
  display:flex;
  flex-direction:column;
}

#messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
}

.message {
  display:flex;
  align-items:flex-start;
  margin-bottom:8px;
}

.message img {
  width:40px;
  height:40px;
  border-radius:50%;
  margin-right:8px;
  object-fit:cover;
}

.message-content {
  background:var(--panel);
  padding:8px;
  border-radius:8px;
  position:relative;
  max-width:70%;
}

.delete-msg {
  position:absolute;
  right:5px;
  top:5px;
  cursor:pointer;
  font-size:12px;
}

.profile-card {
  background:rgb(182, 131, 147);
  padding:5px;
  margin-bottom:5px;
  border-radius:5px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
}

.profile-left {
  display:flex;
  align-items:center;
}

.profile-left img {
  width:30px;
  height:30px;
  border-radius:50%;
  object-fit:cover;
  margin-right:6px;
}

input, textarea, button, select {
  width:100%;
  margin-top:5px;
  padding:5px;
}
</style>
</head>

<body>
<div id="sidebar">
<h1>üí¨ WeChat</h1>
<hr>
<h2>‚ÑπÔ∏è How to use this application</h2>
<div class="box">
	<a class="button" href="#popup1">Info</a>
</div>

<div id="popup1" class="overlay">
	<div class="popup">
		<h2>How to use this application:</h2>
    <hr>
		<a class="close" href="#">&times;</a>
		<div class="content textpopcolor">
			Tap on a created profile to reply as a profile. 
      <hr>
      ‚Ä¢ create unlimited profiles
      <br>
      ‚Ä¢ create unlimited notes on profiles & label them. 
      <br>
      ‚Ä¢ create unlimited chatrooms 
      <br>
      ‚Ä¢ import & export password protected JSON files between devices.
		</div>
	</div>
</div>
<hr>
<h2>Profiles</h2>
<div id="profiles"></div>
<button onclick="addProfile()">+ Add Profile</button>

<hr>

<h2>Chatrooms</h2>
<select id="roomSelect" onchange="switchRoom()"></select>
<button onclick="addRoom()">+ Add Room</button>
<button onclick="deleteRoom()">Delete Room</button>

<hr>

<button onclick="toggleTheme()">Toggle Theme</button>
<button onclick="exportData()">Export</button>
<hr>
<h2 style="text-align:center;">Import</h2>
<input type="file" onchange="importData(event)">
<hr>
<br>
</div>

<div id="main">
<div id="messages"></div>

<div style="display:flex;">
<input id="chatInput" placeholder="Message">
<button onclick="sendMessage()">Send</button>
</div>
<div style="height: 10vh;"></div>
</div>
<!-- PROFILE MODAL -->
<div id="profileModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;">
<div style="background:var(--panel);padding:20px;width:400px;max-height:90vh;overflow-y:auto;border-radius:10px;">
<h2>Edit Profile</h2>

<img id="modalAvatarPreview" style="width:100px;height:100px;border-radius:50%;object-fit:cover;"><br>
<input type="file" id="modalAvatarUpload">

<label>Name</label>
<input id="modalName">

<label>Bio</label>
<textarea id="modalBio"></textarea>

<label>Trigger Notes</label>
<textarea id="modalTriggers"></textarea>

<h2>Labeled Notes</h2>
<div id="modalNotes"></div>
<button onclick="addNoteField()">+ Add Note</button>

<br><br>
<button onclick="saveProfileModal()">Save</button>
<button onclick="deleteProfile()">Delete Profile</button>
<button onclick="closeProfileModal()">Close</button>
</div>
</div>

<script>
let db;
let state = { profiles:[], rooms:["Main"], messages:{} };
let activeProfile = null;
let activeRoom = "Main";
let currentModalProfile = null;

const request = indexedDB.open("PluralDB",1);
request.onupgradeneeded = e=>{
  db = e.target.result;
  db.createObjectStore("store");
};
request.onsuccess = e=>{
  db = e.target.result;
  loadData();
};

function saveData(){
  const tx = db.transaction("store","readwrite");
  tx.objectStore("store").put(state,"data");
}

function loadData(){
  const tx = db.transaction("store","readonly");
  const req = tx.objectStore("store").get("data");
  req.onsuccess = ()=>{
    if(req.result) state = req.result;
    renderAll();
  };
}

function renderAll(){
  renderProfiles();
  renderRooms();
  renderMessages();
}

function addProfile(){
  const id = Date.now();
  state.profiles.push({
    id,
    name:"Alter "+(state.profiles.length+1),
    avatar:"",
    bio:"",
    triggers:"",
    notes:[]
  });
  saveData();
  renderProfiles();
}

function renderProfiles(){
  const div=document.getElementById("profiles");
  div.innerHTML="";
  state.profiles.forEach((p,i)=>{
    const card=document.createElement("div");
    card.className="profile-card";

    const left=document.createElement("div");
    left.className="profile-left";
    left.onclick=()=>activeProfile=p.id;

    const img=document.createElement("img");
    img.src=p.avatar || "";
    left.appendChild(img);

    const name=document.createElement("span");
    name.innerText=(i+1)+". "+p.name;
    left.appendChild(name);

    const infoBtn=document.createElement("button");
    infoBtn.innerText="‚Ñπ";
    infoBtn.style.width="30px";
    infoBtn.onclick=(e)=>{
      e.stopPropagation();
      openProfileModal(p.id);
    };

    card.appendChild(left);
    card.appendChild(infoBtn);
    div.appendChild(card);
  });
}

function deleteRoom(){
  if(activeRoom==="Main"){
    alert("Main room cannot be deleted.");
    return;
  }
  if(!confirm("Delete this room?")) return;

  state.rooms=state.rooms.filter(r=>r!==activeRoom);
  delete state.messages[activeRoom];
  activeRoom="Main";
  saveData();
  renderRooms();
  renderMessages();
}

function addRoom(){
  const name=prompt("Room name?");
  if(!name) return;
  state.rooms.push(name);
  saveData();
  renderRooms();
}

function renderRooms(){
  const sel=document.getElementById("roomSelect");
  sel.innerHTML="";
  state.rooms.forEach(r=>{
    const opt=document.createElement("option");
    opt.value=r;
    opt.innerText=r;
    sel.appendChild(opt);
  });
  sel.value=activeRoom;
}

function switchRoom(){
  activeRoom=document.getElementById("roomSelect").value;
  renderMessages();
}

function sendMessage(){
  if(!activeProfile) return alert("Select profile first");
  const text=document.getElementById("chatInput").value;
  if(!text) return;

  if(!state.messages[activeRoom]) state.messages[activeRoom]=[];
  state.messages[activeRoom].push({
    id:Date.now(),
    profile:activeProfile,
    text
  });

  document.getElementById("chatInput").value="";
  saveData();
  renderMessages();
}

function renderMessages(){
  const div=document.getElementById("messages");
  div.innerHTML="";
  const msgs=state.messages[activeRoom]||[];
  msgs.forEach(m=>{
    const p=state.profiles.find(x=>x.id===m.profile);
    const wrap=document.createElement("div");
    wrap.className="message";
    wrap.innerHTML=
      "<img src='"+(p?.avatar||"")+"'>"+
      "<div class='message-content'><b>"+p?.name+"</b><br>"+m.text+
      "<span class='delete-msg' onclick='deleteMessage("+m.id+")'>‚úñ</span></div>";
    div.appendChild(wrap);
  });
}

function deleteMessage(id){
  state.messages[activeRoom]=state.messages[activeRoom].filter(m=>m.id!==id);
  saveData();
  renderMessages();
}

/* Modal logic remains unchanged from previous version */
function openProfileModal(id){
  currentModalProfile=id;
  const p=state.profiles.find(x=>x.id===id);
  document.getElementById("modalName").value=p.name;
  document.getElementById("modalBio").value=p.bio;
  document.getElementById("modalTriggers").value=p.triggers;
  document.getElementById("modalAvatarPreview").src=p.avatar||"";
  const notesDiv=document.getElementById("modalNotes");
  notesDiv.innerHTML="";
  p.notes.forEach((note,i)=>{
    const wrap=document.createElement("div");
    wrap.innerHTML=
    "Label:<input value='"+note.label+"'><br>"+
    "Note:<textarea>"+note.text+"</textarea>"+
    "<button onclick='deleteNote("+i+")'>Delete Note</button><hr>";
    notesDiv.appendChild(wrap);
  });
  document.getElementById("profileModal").style.display="flex";
}

function addNoteField(){
  const div=document.createElement("div");
  div.innerHTML=
  "Label:<input><br>"+
  "Note:<textarea></textarea><hr>";
  document.getElementById("modalNotes").appendChild(div);
}

function deleteNote(i){
  const p=state.profiles.find(x=>x.id===currentModalProfile);
  p.notes.splice(i,1);
  saveData();
  openProfileModal(currentModalProfile);
}

function saveProfileModal(){
  const p=state.profiles.find(x=>x.id===currentModalProfile);
  p.name=document.getElementById("modalName").value;
  p.bio=document.getElementById("modalBio").value;
  p.triggers=document.getElementById("modalTriggers").value;

  const inputs=document.querySelectorAll("#modalNotes div");
  p.notes=[];
  inputs.forEach(div=>{
    const label=div.querySelector("input")?.value||"";
    const text=div.querySelector("textarea")?.value||"";
    if(label||text) p.notes.push({label,text});
  });

  saveData();
  renderProfiles();
  closeProfileModal();
}

function deleteProfile(){
  if(!confirm("Delete this profile?")) return;
  state.profiles=state.profiles.filter(p=>p.id!==currentModalProfile);
  saveData();
  closeProfileModal();
  renderProfiles();
}

function closeProfileModal(){
  document.getElementById("profileModal").style.display="none";
}

document.getElementById("modalAvatarUpload").addEventListener("change",function(){
  const file=this.files[0];
  const reader=new FileReader();
  reader.onload=()=>{
    const p=state.profiles.find(x=>x.id===currentModalProfile);
    p.avatar=reader.result;
    document.getElementById("modalAvatarPreview").src=reader.result;
    saveData();
    renderProfiles();
  };
  if(file) reader.readAsDataURL(file);
});

function toggleTheme(){
  document.body.classList.toggle("light");
}

document.addEventListener("keydown",e=>{
  if(e.altKey){
    const index=parseInt(e.key)-1;
    if(state.profiles[index]) activeProfile=state.profiles[index].id;
  }
});
</script>

</body>
</html>

